# tkr CLI Environment Configuration

# FIRST: Exit existing devbox shell if we're in one (prevents shell inception)
if [[ "$DEVBOX_SHELL_ENABLED" == "1" ]]; then
    echo "ğŸ”„ Exiting existing devbox shell to prevent shell inception..."
    exit 0
fi

# Helper functions to modify PATH idempotently
path_prepend() {
  local p="$1"
  if [ -d "$p" ] && [[ ":$PATH:" != *":$p:"* ]]; then
    export PATH="$p:$PATH"
  fi
}

path_append() {
  local p="$1"
  if [ -d "$p" ] && [[ ":$PATH:" != *":$p:"* ]]; then
    export PATH="$PATH:$p"
  fi
}

# Ensure nix profile bin is on PATH for direnv hooks
# 1. Clean install (multi-user default) -> First priority
path_prepend "/nix/var/nix/profiles/default/bin"

# 2. User profile (often used by system package manager installs or single-user) -> Last priority
if ! command -v nix >/dev/null 2>&1; then
    path_append "$HOME/.nix-profile/bin"
fi

# Install Nix if not available
if ! command -v nix-shell >/dev/null 2>&1; then
    echo "âš ï¸ Nix not found. Installing Nix..."
    curl -L https://nixos.org/nix/install | sh
fi

# Ensure devbox is available
if ! command -v devbox >/dev/null 2>&1; then
    if [ -d "$HOME/.nix-profile/bin" ]; then
        path_append "$HOME/.nix-profile/bin"
    fi
fi

if ! command -v devbox >/dev/null 2>&1; then
    echo "âš ï¸ Devbox not found. Installing via Nix..."
    nix profile install nixpkgs/nixpkgs-unstable#devbox
    if [ -d "$HOME/.nix-profile/bin" ]; then
        path_append "$HOME/.nix-profile/bin"
    fi
fi

# Verify devbox is available
if ! command -v devbox >/dev/null 2>&1; then
    echo "âŒ Devbox installation failed or binary not found in PATH." >&2
    exit 1
fi

use_devbox() {
    watch_file devbox.json
    eval "$(devbox shellenv)"
}

if command -v devbox >/dev/null 2>&1; then
    use devbox
fi

echo "ğŸ« tkr CLI environment initialized"
echo "ğŸ’¡ Run 'tk --help' to see available commands"
